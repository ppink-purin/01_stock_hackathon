---
marp: true
theme: default
paginate: true
size: 16:9
style: |
  section {
    font-family: 'Comic Neue', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
    background: #FFF8E7;
    color: #222;
  }
  h1 { color: #E8452E; border-bottom: 3px solid #FFDD44; padding-bottom: 8px; }
  h2 { color: #222; }
  h3 { color: #C93A25; }
  code { background: #FFF3CD; border: 1px solid #F0C040; border-radius: 4px; padding: 2px 6px; font-size: 0.85em; }
  pre { background: #1e1e1e !important; border-radius: 12px; border: 2px solid #333; }
  pre code { background: transparent; border: none; color: #d4d4d4; }
  a { color: #E8452E; }
  table { font-size: 0.85em; }
  th { background: #FFDD44; }
  blockquote { border-left: 4px solid #E8452E; background: #FFF3CD; padding: 8px 16px; }
  .columns { display: flex; gap: 24px; }
  .columns > * { flex: 1; }
  footer { color: #A0906B; font-size: 0.6em; }
footer: "주식내비 키우Me -- AI / LLM 통합 강의 | 2026"
---

<!-- _class: lead -->
<!-- _paginate: false -->
<!-- _footer: "" -->

# 🤖 AI / LLM 통합 개발

## 천재 비서에게 일 시키는 법 배우기!

<br>

**프로젝트: 주식내비 키우Me** -- AI 주식 상담 챗봇
Next.js 16 + React 19 + TypeScript + Anthropic Claude Haiku 4.5

<br>

> 🎯 오늘의 목표: "AI 비서를 고용하고, 전화로 질문하고, 요금을 계산하는 법"을 배웁니다!

---

# 📋 오늘의 여행 코스

| 시간 | 섹션 | 일상 비유 |
|---:|:---|:---|
| 5분 | **1. LLM이 뭐야?** | 🧠 수천 권의 책을 읽은 천재 비서 |
| 5분 | **2. API Key 설정** | 🎫 도서관 회원증 만들기 |
| 10분 | **3. 비서에게 업무 지침서 주기** | 📋 시스템 프롬프트 설계 |
| 8분 | **4. 비서에게 도구 허락하기** | 🔧 "계산기 써도 돼!" |
| 8분 | **5. 답변 받는 방식** | 💬 카톡 vs 이메일 (스트리밍) |
| 5분 | **6. 화면에 보여주기** | 📱 실시간 렌더링 |
| 5분 | **7. 답변 정리하기** | ✂️ AI 응답 파싱 |
| 5분 | **8. 요금 계산** | 🚕 택시 미터기 |
| 4분 | **9. 직원 등급 선택** | 👔 인턴 vs 대리 vs 이사 |
| 5분 | **10. 안전장치** | 🛡️ 에러 핸들링 |

---

<!-- _class: lead -->

# 섹션 1
## 🧠 LLM이 뭐야?
### 수천 권의 책을 읽은 천재 비서를 만나보세요!

---

# 🎯 일상에서 찾는 AI 🔍

## 여러분은 이미 AI를 사용하고 있어요!

<br>

| 일상 속 AI | 하는 일 |
|:---|:---|
| 📱 시리/빅스비 | "내일 날씨 알려줘" |
| 🔍 네이버 검색 | 글자 치면 추천 검색어 |
| 📷 카메라 앱 | 얼굴 인식해서 보정 |
| 🎵 멜론/스포티파이 | "이 노래 좋아할 것 같아요" |
| 💬 **ChatGPT / Claude** | 대화하듯 질문하고 답변 받기 |

<br>

> 💡 LLM(Large Language Model)은 이 중에서 **"대화"** 에 특화된 AI예요!

---

# 🎯 비유: 천재 비서를 상상해보세요!

<br>

## 🧠 LLM = 수천 권의 책을 읽은 천재 비서

<br>

```
📚📚📚📚📚📚📚📚📚📚   수천 권의 책을 읽었어요!
📰📰📰📰📰📰📰📰📰📰   뉴스, 논문, 블로그...
🌍🌍🌍🌍🌍🌍🌍🌍🌍🌍   전 세계의 지식을 학습!
              ↓
         🧠 천재 비서
              ↓
    "무엇이든 물어보세요!" 💬
```

<br>

> 마치 **모든 분야의 지식**을 가진 비서가 옆에 앉아 있는 것과 같아요!

---

# 🔗 이것이 AI에서는...

## LLM(대규모 언어 모델)의 동작 원리

비서가 여러분의 질문을 듣고 **한 글자씩** 답변을 써나가요!

```
👤 "삼성전자 요즘 어때?"

🧠 비서의 머릿속:
   "삼성전자" → 다음에 올 글자는? → "현" (80% 확률)
   "삼성전자 현" → 다음은? → "재" (90% 확률)
   "삼성전자 현재" → 다음은? → "가" (85% 확률)
   ...계속 한 글자씩 이어서 작성!
```

### 핵심 포인트 ✨

- 📝 **한 글자(토큰)씩** 답변을 만들어요
- 🎲 **확률**로 다음 글자를 선택해요
- 📖 읽은 책이 많을수록 더 정확해요!

---

# ✅ 한 줄 정리

<br>

## 🧠 LLM = 수천 권의 책을 읽은 천재 비서

<br>

> 여러분의 질문을 듣고, 배운 지식을 바탕으로
> **한 글자씩** 답변을 만들어내는 AI예요!

<br>

### 우리 프로젝트에서는?

**Claude Haiku 4.5** 라는 이름의 비서를 고용했어요! 🐶

---

# 🎯 비유: 토큰 = 택시 미터기 🚕

<br>

## 택시를 타면 **거리만큼** 요금이 올라가죠?

```
🚕 택시 미터기
┌─────────────────────┐
│  기본요금: 4,800원    │
│  거리: 3.2km          │
│  ───────────────      │
│  💰 요금: 7,200원     │  ← 달린 만큼 돈이 나간다!
└─────────────────────┘
```

<br>

## AI도 똑같아요!

> **글자 수(토큰)** 만큼 요금이 올라갑니다! 📈

---

# 🔗 이것이 AI에서는... 토큰(Token)

## 토큰 = AI가 텍스트를 처리하는 **최소 단위**

| 언어 | 텍스트 | 대략적 토큰 수 |
|:---|:---|:---|
| 영어 | `"Hello, world!"` | ~4 토큰 |
| 한국어 | `"삼성전자 현재가 알려줘"` | ~8 토큰 |

### 🇰🇷 한국어 꿀팁!

- 한국어 한 글자 = 보통 **1~2 토큰** (영어보다 많아요!)
- 같은 의미라도 한국어가 영어보다 **토큰이 더 많이** 필요해요
- 토큰이 많으면? → **💰 비용이 더 나가요!**

> 🚕 토큰 = 택시 미터기의 **거리** -- 글자가 많을수록 비용 UP! ⬆️

---

# 🎯 비유: Context Window = 비서의 책상 크기 🪑

<br>

## 비서의 책상이 작으면? → 서류를 많이 올려놓을 수 없어요!

```
┌──────────── 📐 비서의 책상 (200K 토큰) ────────────┐
│                                                       │
│  📋 업무지침서  +  💬 이전 대화  +  📊 조사 결과  +  ❓ 새 질문  │
│   (500 토큰)     (2,000 토큰)   (1,500 토큰)    (50 토큰)  │
│                                                       │
│  ← 여기까지가 비서가 한번에 볼 수 있는 범위 →         │
└───────────────────────────────────────────────────────┘
```

<br>

- 📐 **책상이 크면** = 더 많은 대화를 기억할 수 있어요
- 📐 **책상이 작으면** = 오래된 대화는 잊어버려요

> Claude 비서의 책상 크기 = **200K 토큰** (약 15만 글자!) 📚

---

# 퀴즈 타임! 🤔

<br>

## Q. 다음 중 LLM에 대한 올바른 설명은?

<br>

**A)** LLM은 인터넷에 직접 접속해서 답변한다

**B)** LLM은 학습한 지식을 바탕으로 한 글자씩 답변을 만든다 ✅

**C)** LLM은 항상 100% 정확한 답변을 한다

**D)** LLM은 한국어를 이해하지 못한다

<br>

> 💡 정답: **B!** LLM은 읽은 책(학습 데이터)을 바탕으로 확률적으로 답변해요!
> 인터넷 접속은 별도의 **도구(Tool)** 가 필요합니다 🔧

---

# 🐕 왜 Claude인가? -- 우리가 이 비서를 뽑은 이유!

<br>

| 비서의 능력 | 일상 비유 | 설명 |
|:---|:---|:---|
| 🔧 **Tool Use** | 계산기, 인터넷 사용 가능! | 외부 도구 호출 기능 내장 |
| 💬 **스트리밍** | 카톡처럼 즉시 답변! | 토큰 생성 즉시 실시간 전송 |
| 🇰🇷 **한국어** | 한국어 능통! | 자연스러운 한국어 생성 |
| 📐 **긴 기억력** | 큰 책상! | 200K 토큰 Context Window |
| 📦 **공식 SDK** | 사용 설명서 완비! | TypeScript SDK 제공 |

<br>

> 🎯 우리 프로젝트의 구조 한눈에:
> `사용자 질문 → 서버 → Claude 비서 → 도구 사용 → 답변 → 화면에 표시!`

---

<!-- _class: lead -->

# 섹션 2
## 🎫 API Key 설정
### 도서관 회원증 만들기!

---

# 🎯 비유: API Key = 도서관 회원증 📚

<br>

## 도서관에 가려면 **회원증**이 있어야 하죠?

```
┌─────────────────────────┐
│   📚 Claude AI 도서관     │
│                           │
│   🎫 회원증 (API Key)     │
│   sk-ant-api03-xxxx...    │
│                           │
│   ✅ 회원증 있음 → 입장!  │
│   ❌ 회원증 없음 → 거부!  │
└─────────────────────────┘
```

<br>

- 🎫 **API Key** = Claude에게 접근할 수 있는 **회원증**
- 🔒 **분실 주의** = 다른 사람이 쓰면 요금이 내 카드로!
- 🙈 **비밀 유지** = 절대 코드에 직접 적지 말 것!

---

# 🔗 이것이 AI에서는... SDK 설치 & 초기화

<br>

### 1단계: 비서 회사(Anthropic)와 계약서 설치

```typescript
npm install @anthropic-ai/sdk
```

### 2단계: 회원증으로 비서 부르기 -- 딱 한 줄!

```typescript
const anthropic = new Anthropic();
// 🎫 환경변수에서 API Key를 자동으로 읽어요!
```

<br>

> 💡 `new Anthropic()` 한 줄이면 비서 고용 완료! 쉽죠? 😊

---

# 💻 실제 코드: SDK 초기화

> **파일:** `app/api/chat/route.ts`

```typescript
import Anthropic from "@anthropic-ai/sdk";

const anthropic = new Anthropic();
// 🎫 ANTHROPIC_API_KEY 환경변수를 자동으로 읽어요!
```

### 설정값 의미

| 설정 | 비유 | 설명 |
|:---|:---|:---|
| `runtime = "nodejs"` | 🏢 사무실 위치 | Node.js 환경에서 실행 |
| `maxDuration = 120` | ⏰ 최대 통화시간 | 2분 타임아웃 |
| `new Anthropic()` | 🎫 회원증 제시 | API Key 자동 참조 |

---

# 🔐 회원증(API Key) 안전하게 보관하기

### `.env.local` 파일 = 🗝️ 금고

```bash
# 🎫 Anthropic API Key (서버 전용!)
ANTHROPIC_API_KEY=sk-ant-api03-xxxxxxxxxxxx
```

### API Key 발급 순서 📝

1. [console.anthropic.com](https://console.anthropic.com) 접속
2. **API Keys** 메뉴에서 키 생성 🔑
3. `.env.local` 파일에 저장 📁
4. `.gitignore`에 `.env.local` 포함 확인 ✅

### ⚠️ 절대 주의!

| 🟢 안전 | 🔴 위험 |
|:---|:---|
| `.env.local`에 보관 | 코드에 직접 쓰기 |
| 서버에서만 사용 | 브라우저에 노출 |
| `ANTHROPIC_API_KEY` | `NEXT_PUBLIC_`으로 시작하면 위험! |

---

# ✅ 한 줄 정리

<br>

## 🎫 API Key = 도서관 회원증

<br>

> API Key가 없으면 Claude 비서를 부를 수 없어요!
> `.env.local` 금고에 안전하게 보관하세요 🔒

<br>

### 기억할 것 3가지:

1. 🎫 **회원증 만들기** -- console.anthropic.com
2. 🗝️ **금고에 넣기** -- `.env.local` 파일
3. 🙈 **절대 공개 금지** -- `.gitignore` 확인!

---

<!-- _class: lead -->

# 섹션 3
## 📋 시스템 프롬프트 설계
### 비서에게 업무 지침서 주기!

---

# 🎯 비유: 시스템 프롬프트 = 비서 채용 시 업무 지침서 📋

<br>

## 새 비서를 뽑으면 뭘 해야 할까요?

```
📋 업무 지침서
┌─────────────────────────────────────┐
│  1. 당신의 이름은 "주식내비 키우Me"   │
│  2. 주식 초보 투자자에게 친절히 답변   │
│  3. 4단계로 생각하고 답변하세요        │
│  4. 전문용어는 쉽게 풀어서 설명        │
│  5. 투자 권유는 하지 마세요            │
│  6. 한국어로 답변하세요                │
└─────────────────────────────────────┘
```

<br>

> 📋 **시스템 프롬프트** = AI 비서가 일하기 전에 반드시 읽는 **업무 지침서**!
> 지침서가 좋으면 답변도 좋아져요! ✨

---

# 🔗 이것이 AI에서는... 시스템 프롬프트의 4가지 요소

<br>

### 좋은 업무 지침서의 구성 📋

| 순서 | 요소 | 비유 | 예시 |
|:---|:---|:---|:---|
| 1️⃣ | **역할 정의** | "너의 이름은..." | "주식내비 키우Me입니다" |
| 2️⃣ | **행동 지시** | "이렇게 일해" | "4단계로 사고하세요" |
| 3️⃣ | **출력 형식** | "보고서 양식" | "마크다운으로 작성" |
| 4️⃣ | **제약 조건** | "하면 안 되는 것" | "투자 권유 금지" |

<br>

> 🎯 시스템 프롬프트의 품질 = AI 서비스의 품질!
> **좋은 지침서를 주면, 좋은 답변이 돌아옵니다** ✨

---

# 💻 실제 코드: 역할 정의

> **파일:** `app/api/chat/route.ts`

```typescript
const systemPrompt = `당신은 '주식내비 키우Me'입니다.
주식 초보 투자자의 질문에 친절하고 이해하기 쉽게
답변합니다.`;
```

### 설계 포인트 ✨

| 표현 | 비유 | 효과 |
|:---|:---|:---|
| `'주식내비 키우Me'` | 이름표 달아주기 🏷️ | 일관된 성격 유지 |
| `초보 투자자` | "쉽게 설명해" 📢 | 답변 난이도 조절 |
| `다음 금융, 네이버 금융` | "이 자료 참고해" 📊 | 실제 데이터 사용 유도 |

<br>

> 💡 데이터 소스를 명시하면 비서가 **"도구를 써서 진짜 데이터를 찾아야겠다!"** 라고 판단해요

---

# 🎯 비유: Chain-of-Thought = "풀이 과정을 보여주세요!" ✏️

<br>

## 수학 시험 기억나세요?

```
📝 수학 시험
┌─────────────────────────────────┐
│  문제: 사과 3개에 300원이면       │
│       사과 10개는 얼마?          │
│                                   │
│  ❌ 답: 1,000원 (풀이 없음)       │
│  ✅ 풀이:                         │
│     1. 사과 1개 = 300 ÷ 3 = 100원│
│     2. 사과 10개 = 100 x 10      │
│     3. 답: 1,000원                │
└─────────────────────────────────┘
```

<br>

> **풀이 과정을 보여달라고 하면** → 더 정확한 답이 나와요!
> AI도 마찬가지! 이것을 **Chain-of-Thought(사고의 연쇄)** 라고 해요 🧠

---

# 🔗 이것이 AI에서는... CoT 4단계

<br>

### 우리 비서의 사고 과정 4단계

```
🔍 의도 분석    →   📋 탐색 계획    →   📊 정보 수집    →   💡 최종 답변
  "뭘 원하지?"       "뭘 찾아볼까?"       "찾았다!"         "답변 드릴게요!"
```

| 단계 | 비서가 하는 일 | 사용자가 보는 것 |
|:---|:---|:---|
| 🔍 의도 분석 | "삼성전자 종합 정보를 원하시는군" | "내 질문을 이해했구나!" |
| 📋 탐색 계획 | "시세 조회 + 뉴스 검색 해야겠다" | "어떤 정보를 찾는지 보인다!" |
| 📊 정보 수집 | 도구로 실제 데이터 수집 | "실시간 데이터를 쓰는구나!" |
| 💡 최종 답변 | 쉽고 친절하게 정리 | "이해하기 쉽다!" |

> 🎯 **투명성** + **정확성** = 단계적 사고의 힘!

---

# 💻 실제 코드: 4단계 사고 지시

> **파일:** `app/api/chat/route.ts`

```text
반드시 다음 4단계로 사고하고 표시하세요:

## 🔍 의도 분석
사용자 질문의 의도를 파악합니다.

## 📋 탐색 계획
어떤 정보를 수집할지 계획합니다.

## 📊 정보 수집 및 분석
도구를 호출하여 데이터를 수집합니다.

## 💡 최종 답변
초보 투자자가 이해하기 쉽게 답변합니다.
```

> ✏️ "풀이 과정을 보여주세요!" 를 AI 버전으로 쓴 것이에요!

---

# 📋 출력 규칙 -- 비서에게 "이것만은 꼭!" 전달하기

> **파일:** `app/api/chat/route.ts`

### 비서에게 내린 특별 지시사항

| 규칙 | 비유 | 이유 |
|:---|:---|:---|
| 종목명 → `searchStock` 먼저! | "고객 이름 먼저 확인해!" | 종목코드 없이 조회 불가 |
| 데이터 출처 표기 | "참고 자료 밝히기" | 법적 의무 |
| "투자 권유 아님" 명시 | "면책 조항" | 법적 보호 |
| 숫자 포맷: `1,234,567원` | "읽기 쉽게 정리" | 가독성 |
| 전문용어 설명: `PER(주가수익비율)` | "초보자 눈높이" | 이해도 |

<br>

> 💡 **좋은 지침서 = 좋은 서비스 품질!**
> 규칙이 구체적일수록 비서의 답변이 일관되어요 ✨

---

# 🎯 비유: 프롬프트 엔지니어링 = 좋은 질문이 좋은 답을 만든다!

<br>

## 5W1H를 기억하세요!

```
❌ 나쁜 질문: "주식 알려줘"
   → 비서: "...뭘 알려드릴까요?" 😅

✅ 좋은 질문: "삼성전자의 현재 주가와 최근 뉴스를
              초보자도 이해하기 쉽게 설명해줘"
   → 비서: "네! 삼성전자는 현재..." 📊
```

<br>

### 좋은 프롬프트의 비밀 🔑

| 요소 | 나쁜 예 | 좋은 예 |
|:---|:---|:---|
| Who (누구에게) | (없음) | "초보 투자자에게" |
| What (무엇을) | "알려줘" | "현재가와 뉴스를" |
| How (어떻게) | (없음) | "쉽게 설명해줘" |

---

# 📋 후속 질문 생성 -- 구조화된 출력 설계

> **파일:** `app/api/chat/route.ts`

### 비서에게 "후속 질문도 만들어줘!" 지시하기

```text
최종 답변의 맨 마지막에 반드시 아래 형식으로
후속 질문 3개를 추가하세요:
[추천질문: 질문1 | 질문2 | 질문3]
```

### 왜 이 형식인가요? 🤔

| 설계 포인트 | 이유 |
|:---|:---|
| `[추천질문: ...]` 대괄호 | 컴퓨터가 찾기 쉬운 표시 |
| `|` 구분자 | 질문 3개를 깔끔하게 분리 |
| "15자 내외" | UI 버튼 크기에 맞게 |

> 🎯 프롬프트로 **형식을 정하고**, 코드로 **파싱** -- 이것이 실전 패턴!

---

# ✅ 한 줄 정리

<br>

## 📋 시스템 프롬프트 = 비서 채용 시 업무 지침서

<br>

> **좋은 지침서 → 좋은 비서 → 좋은 서비스!** ✨

<br>

### 기억할 것 4가지:

1. 🏷️ **역할 정의** -- "너는 주식 상담 비서야"
2. ✏️ **사고 과정** -- "풀이 과정을 보여줘" (CoT)
3. 📝 **출력 형식** -- "이 양식으로 답변해"
4. 🚫 **제약 조건** -- "투자 권유는 하지 마"

---

<!-- _class: lead -->

# 섹션 4
## 🔧 도구(Tool) 허락하기
### "계산기 써도 돼!" "인터넷 검색해도 돼!"

---

# 🎯 비유: Tool Use = 비서에게 도구 허락하기 🛠️

<br>

## 비서에게 "이 도구들 써도 돼!" 라고 허락해주는 거예요

```
📋 비서에게 허락한 도구 목록

  🔍 종목 검색기    -- "이 회사 종목코드 찾아줘"
  📊 시세 조회기    -- "현재 주가 확인해줘"
  📰 뉴스 검색기    -- "관련 뉴스 찾아줘"
  🌍 시장 현황판    -- "코스피 전체 보여줘"
```

<br>

> 💡 도구 없이는 비서가 **기억에만 의존**해요 (정확도 ↓)
> 도구를 주면 **실시간 정보**를 가져올 수 있어요! (정확도 ↑)

---

# 🔗 이것이 AI에서는... Tool 정의

### 도구마다 **설명서**가 필요해요!

| 도구 이름 | 비유 | 설명서 핵심 |
|:---|:---|:---|
| `searchStock` | 🔍 전화번호부 | "종목코드를 모를 때 **먼저** 사용" |
| `getStockQuote` | 📊 시세 전광판 | "현재 시세, 등락률, PER 등" |
| `getStockNews` | 📰 뉴스 구독 | "종목 관련 **최신** 뉴스" |
| `getMarketOverview` | 🌍 시장 현황판 | "코스피, 코스닥 **전체** 현황" |

### 도구 설명서 작성 팁 📝

```
❌ 나쁜 설명: "주식 검색"                    -- 너무 막연해요
✅ 좋은 설명: "종목명으로 종목코드를 검색합니다.
              종목코드를 모를 때 먼저 사용하세요." -- 용도 + 조건 명시!
```

> Claude는 **설명서를 읽고** 언제 어떤 도구를 쓸지 스스로 판단해요! 🧠

---

# 💻 실제 코드: 도구 정의

> **파일:** `lib/tools.ts`

```typescript
export const toolDefinitions = [
  {
    name: "searchStock",
    description: "종목명으로 종목코드를 검색합니다.
      종목코드를 모를 때 먼저 사용하세요.",
    input_schema: {
      properties: {
        query: { type: "string",
          description: "검색할 종목명 (예: 삼성전자)" }
      }
    }
  },
  // ... 추가 도구들
];
```

> 🎯 `description`이 핵심! 비서는 이 설명을 읽고 **스스로 도구를 선택**해요

---

# 🎯 비유: Agentic Loop = 비서의 업무 흐름 🔄

<br>

## 비서가 알아서 여러 번 조사하는 과정!

```
👤 "삼성전자 요즘 어때?"
     │
     ├─ 📞 1차 조사: 🔍 종목 검색기 사용
     │   → "삼성전자 = 005930번!"
     │
     ├─ 📞 2차 조사: 📊 시세 조회 + 📰 뉴스 검색
     │   → "현재 75,000원, 전일대비 +2.3%"
     │   → "AI 반도체 수주 뉴스 3건"
     │
     └─ 📝 최종 보고서 작성!
         → "삼성전자는 현재 75,000원이며..."
```

<br>

> 💡 비서가 **"아직 정보가 부족해!"** 라고 판단하면 자동으로 다음 조사를 시작해요!

---

# 💻 실제 코드: Agentic Loop

> **파일:** `app/api/chat/route.ts`

```typescript
let turnCount = 0;
const maxTurns = 10;  // 최대 10번까지 조사!

while (turnCount < maxTurns) {
  // Claude에게 질문 → 도구 호출 여부 확인
  // 도구 필요 없으면 → 최종 답변! → break;
  // 도구 필요하면 → 실행 후 다음 턴!
}
```

### 핵심 포인트 ✨

- 🔄 **반복**: 비서가 "더 조사 필요!"하면 자동 반복
- 🛑 **안전장치**: 최대 10턴으로 제한 (무한 반복 방지)
- 🏁 **종료 조건**: 도구 호출 없으면 = 답변 완성!

---

# ✅ 한 줄 정리

<br>

## 🔧 Tool Use = 비서에게 "계산기 써도 돼!" 허락하기

<br>

> 도구를 주면 비서가 **실시간 데이터**를 가져올 수 있어요!
> 기억에만 의존하면 **틀릴 수 있지만**, 도구를 쓰면 **정확**해져요! 🎯

<br>

### 우리 비서의 도구 4종 세트:

- 🔍 **종목 검색** -- 전화번호부
- 📊 **시세 조회** -- 시세 전광판
- 📰 **뉴스 검색** -- 뉴스 구독
- 🌍 **시장 현황** -- 시장 현황판

---

<!-- _class: lead -->

# 섹션 5
## 💬 스트리밍 응답
### 카카오톡 vs 이메일 -- 어떤 게 더 좋을까?

---

# 🎯 비유: 스트리밍 = 카톡 "입력 중..." 💬

<br>

## 답변 받는 두 가지 방식

<div class="columns">
<div>

### 📧 이메일 방식 (일반 응답)

```
✉️ ........전송 중.........
     (10초 동안 아무것도 안 보임)
✉️ 도착! [전체 텍스트 한번에]
```

😩 "로딩 중... 언제 오지?"

</div>
<div>

### 💬 카톡 방식 (스트리밍)

```
💬 입력 중...
💬 삼
💬 삼성
💬 삼성전자의
💬 삼성전자의 현재가는...
```

😊 "오! 답변하고 있구나!"

</div>
</div>

<br>

> 🎯 스트리밍 = **한 글자씩 실시간으로** 답변이 나타나는 방식!

---

# 🔗 이것이 AI에서는... SSE (Server-Sent Events)

### 서버가 한 조각씩 보내주는 실시간 통신!

```
📱 브라우저 ←───────── 🖥️ 서버

  data: {"type":"text_delta","text":"삼성"}     ← 한 조각!
  data: {"type":"text_delta","text":"전자의"}   ← 또 한 조각!
  data: {"type":"text_delta","text":" 현재가는"} ← 또!
  data: {"type":"tool_call","name":"시세 조회"}  ← 도구 사용 알림!
  data: {"type":"done","text":"...전체 텍스트..."} ← 완료!
```

### SSE vs WebSocket

| | 📡 SSE | 🔌 WebSocket |
|:---|:---|:---|
| 비유 | 📻 라디오 (듣기만) | 📞 전화 (양방향) |
| 방향 | 서버 → 클라이언트 | 양방향 |
| AI 챗봇에 적합? | **최적!** ✅ | 과잉 스펙 |

---

# 💻 실제 코드: 서버 스트리밍 설정

> **파일:** `app/api/chat/route.ts`

```typescript
const stream = new ReadableStream({
  async start(controller) {
    const send = (data) => {
      controller.enqueue(
        encoder.encode(`data: ${JSON.stringify(data)}\n\n`)
      );
    };
    // ... AI 처리 → send()로 한 조각씩 전송!
    controller.close();  // 📡 방송 종료!
  },
});
```

### 핵심 API 2개만 기억! 📝

| 메서드 | 비유 | 역할 |
|:---|:---|:---|
| `controller.enqueue()` | 📻 방송 송출 | 데이터 조각 전송 |
| `controller.close()` | 📻 방송 종료 | 스트림 닫기 (필수!) |

---

# 💻 Claude SDK 스트리밍 호출

> **파일:** `app/api/chat/route.ts`

```typescript
// 1. Claude 비서에게 스트리밍으로 질문!
const stream = anthropic.messages.stream({
  model: "claude-haiku-4-5-20251001",
  max_tokens: 4096,
  system: systemPrompt,    // 📋 업무 지침서
  messages: apiMessages,    // 💬 대화 내용
  tools: toolDefinitions,   // 🔧 도구 목록
});

// 2. 글자가 나올 때마다 실시간 전송!
stream.on("text", (text) => {
  send({ type: "text_delta", text });
});
```

<br>

> 💬 `stream.on("text")` = 카톡의 "입력 중..." 처럼 한 글자씩 바로 전송!

---

# 📡 우리 프로젝트의 4가지 이벤트 타입

### 서버가 보내는 신호 종류

| 이벤트 | 이모지 | 비유 | 언제? |
|:---|:---|:---|:---|
| `text_delta` | 💬 | 카톡 한 글자 | 글자 생성할 때마다 |
| `tool_call` | 🔧 | "잠깐, 자료 찾는 중!" | 도구 사용할 때 |
| `error` | ❌ | "죄송, 문제 발생!" | 에러 났을 때 |
| `done` | ✅ | "답변 완료!" | 모든 답변 끝났을 때 |

<br>

> 🎯 4가지 신호만 알면 AI 챗봇의 통신을 이해한 거예요!

---

# ✅ 한 줄 정리

<br>

## 💬 스트리밍 = 카톡 "입력 중..." (한 글자씩 실시간으로!)

<br>

> 📧 이메일 방식: 10초 기다림 → 한번에 도착
> 💬 카톡 방식: 즉시 한 글자씩 → 자연스러운 대화!

<br>

### ChatGPT도 이렇게 동작해요!

타이핑하듯 글자가 나타나는 것 = **스트리밍** 💬

---

<!-- _class: lead -->

# 섹션 6
## 📱 클라이언트 스트리밍 소비
### 화면에 실시간으로 보여주기!

---

# 🎯 비유: 라디오 청취 📻

<br>

## 라디오 방송을 수신하는 것처럼!

```
📻 라디오 수신기 (브라우저)

1. 📡 주파수 맞추기    → fetch("/api/chat")
2. 🔊 소리 듣기        → reader.read()
3. 📝 받아적기         → 텍스트 누적
4. 🖥️ 화면에 표시     → setMessages()
5. 🔚 방송 종료 감지   → done === true
```

<br>

> 서버가 보내는 데이터를 **한 조각씩** 수신해서 화면에 보여주는 거예요!

---

# 💻 실제 코드: SSE 수신

> **파일:** `components/chat.tsx`

```typescript
const response = await fetch("/api/chat", {
  method: "POST",
  body: JSON.stringify({ messages, sessionId }),
});

const reader = response.body.getReader();
const decoder = new TextDecoder();

while (true) {
  const { done, value } = await reader.read();
  if (done) break;  // 📻 방송 끝!
  // ... 받은 데이터 처리
}
```

> 📻 `reader.read()` = 라디오에서 소리 한 조각 듣기!

---

# 💻 이벤트별 화면 업데이트

> **파일:** `components/chat.tsx`

```typescript
if (data.type === "text_delta") {
  // 💬 글자 누적! "삼" → "삼성" → "삼성전자"
  setMessages(prev => {
    const last = updated[updated.length - 1];
    last.content = last.content + data.text;
    return updated;
  });
} else if (data.type === "tool_call") {
  // 🔧 "지금 자료 찾는 중!" 표시
} else if (data.type === "done") {
  // ✅ 답변 완료! 로딩 해제
}
```

> 💬 `text_delta`가 올 때마다 글자를 이어 붙여서 카톡처럼 보이게 해요!

---

# ✅ 한 줄 정리

<br>

## 📻 클라이언트 = 라디오 수신기

<br>

> 서버(방송국)가 보내는 데이터를 **한 조각씩** 받아서
> 화면에 **실시간으로** 표시해요!

<br>

### 수신 흐름 3단계:

1. 📡 **연결** -- `fetch("/api/chat")`
2. 📻 **수신** -- `reader.read()`로 한 조각씩
3. 📱 **표시** -- `setMessages()`로 화면 업데이트

---

<!-- _class: lead -->

# 섹션 7
## ✂️ AI 응답 파싱
### 비서의 보고서를 보기 좋게 정리하기!

---

# 🎯 비유: 보고서를 예쁘게 정리하기 ✂️

<br>

## 비서가 보낸 긴 보고서를 섹션별로 나눠야 해요!

```
📄 비서의 원본 보고서
┌──────────────────────────┐
│ ## 🔍 의도 분석            │ → 📁 접기/펼치기 아코디언
│ 삼성전자 정보를 원하시는군 │
│                            │
│ ## 📋 탐색 계획            │ → 📁 접기/펼치기 아코디언
│ 시세 + 뉴스 조회 계획      │
│                            │
│ ## 💡 최종 답변            │ → 💬 메인 말풍선 (항상 표시)
│ 삼성전자는 현재 75,000원.. │
│                            │
│ [추천질문: A | B | C]      │ → 🔘 클릭 가능한 버튼 3개
└──────────────────────────┘
```

> ✂️ 보고서를 **잘라서** 각 부분을 다른 UI로 표현해요!

---

# 💻 실제 코드: parseThinkingSteps()

> **파일:** `components/message-bubble.tsx`

```typescript
function parseThinkingSteps(text) {
  // 🔍 📋 📊 사고 과정을 정규식으로 추출
  const stepPatterns = [
    { pattern: /## 🔍 의도 ?분석\n(...)/, label: "의도 분석" },
    { pattern: /## 📋 탐색 ?계획\n(...)/, label: "탐색 계획" },
    { pattern: /## 📊 정보 ?수집\n(...)/, label: "정보 수집" },
  ];
  // 💡 최종 답변은 별도 추출
  const finalMatch = /## 💡 최종 ?답변\n(...)/.exec(text);
  return { steps, finalAnswer };
}
```

### 프롬프트 ↔ 코드 연결 🔗

> 📋 프롬프트에서 **"## 🔍 의도 분석"** 형식을 강제했기 때문에
> ✂️ 코드에서 이 형식을 **찾아서 잘라낼 수** 있는 거예요!

---

# 💻 실제 코드: parseFollowUpQuestions()

> **파일:** `components/message-bubble.tsx`

```typescript
function parseFollowUpQuestions(text) {
  // [추천질문: 삼성전자 뉴스? | 코스피 현황? | 현대차 시세?]
  const match = /\[추천질문:\s*(.+?)\]/.exec(text);
  const questions = match[1]
    .split("|")        // "|"로 분리
    .map(q => q.trim()) // 공백 제거
  return { cleanText, questions };
}
```

### 결과:

```
입력: "[추천질문: 삼성전자 뉴스? | 코스피 현황? | 현대차 시세?]"
출력: ["삼성전자 뉴스?", "코스피 현황?", "현대차 시세?"]
      → 🔘 클릭 가능한 버튼 3개로 변신!
```

---

# 🎯 핵심 인사이트: 프롬프트와 파싱은 한 쌍! 🤝

<br>

```
📋 시스템 프롬프트 (route.ts)       ✂️ 클라이언트 파싱 (message-bubble.tsx)
─────────────────────────           ──────────────────────────────────
## 🔍 의도 분석         ──regex──>  📁 접기/펼치기 아코디언
## 📋 탐색 계획         ──regex──>  📁 접기/펼치기 아코디언
## 💡 최종 답변         ──regex──>  💬 메인 말풍선 (항상 표시)
[추천질문: A | B | C]   ──regex──>  🔘 클릭 가능한 버튼 3개
```

<br>

> ⚠️ **프롬프트 형식을 바꾸면 → 파싱 코드도 바꿔야 해요!**
> 둘은 항상 **한 쌍**으로 관리해야 합니다 🤝

---

# ✅ 한 줄 정리

<br>

## ✂️ AI 응답 파싱 = 보고서를 예쁘게 정리하기

<br>

> 프롬프트로 **형식을 정하고** → 코드로 **잘라서** → UI로 **예쁘게**!

<br>

### 파싱 결과물 3가지:

1. 📁 **사고 과정** → 접기/펼치기 아코디언
2. 💬 **최종 답변** → 메인 말풍선
3. 🔘 **후속 질문** → 클릭 버튼

---

<!-- _class: lead -->

# 섹션 8
## 🚕 토큰 비용 계산
### 택시 미터기 영수증 읽는 법!

---

# 🎯 비유: AI 비용 = 택시비 영수증 🧾

<br>

## 택시비처럼 **사용한 만큼** 돈이 나가요!

```
🧾 AI 택시비 영수증
┌─────────────────────────────┐
│  🚕 AI 택시                  │
│                               │
│  📥 질문한 거리 (입력 토큰)   │  ← 질문 + 대화 기록
│     3,800 토큰 = 5.51원       │
│                               │
│  📤 답변한 거리 (출력 토큰)   │  ← AI가 쓴 답변
│     850 토큰 = 6.16원         │
│  ─────────────────────────── │
│  💰 합계: 11.67원             │
└─────────────────────────────┘
```

<br>

> 💡 카카오톡 대화 한번 = 약 **10~20원!** 커피 한 잔보다 훨씬 싸요 ☕

---

# 🔗 이것이 AI에서는... 비용 공식

### LLM API의 과금 방식

```
💰 총 비용 = (입력 토큰 x 입력 단가) + (출력 토큰 x 출력 단가)
```

### 왜 출력이 5배 비쌀까? 🤔

| 구분 | 비유 | 단가 (Haiku 4.5) |
|:---|:---|:---|
| 📥 **입력 토큰** | 택시가 출발지 확인 (쉬움) | $1.00 / 100만 토큰 |
| 📤 **출력 토큰** | 택시가 직접 운행 (힘듦) | $5.00 / 100만 토큰 |

<br>

- 📥 입력 = 단순히 **읽기** (빠르고 쉬움)
- 📤 출력 = 한 글자씩 **생성** (연산량이 5배!)

> 🚕 택시도 "대기 요금"보다 "주행 요금"이 비싸죠?

---

# 💻 실제 코드: 비용 계산

> **파일:** `app/api/chat/route.ts`

```typescript
const USD_TO_KRW = 1450;
const inputCostKRW =
  (totalInputTokens / 1_000_000) * 1.0 * USD_TO_KRW;
const outputCostKRW =
  (totalOutputTokens / 1_000_000) * 5.0 * USD_TO_KRW;
const totalCostKRW = inputCostKRW + outputCostKRW;
```

### 한글 공식 📝

```
입력 비용(원) = (입력 토큰 ÷ 1,000,000) x $1.00 x 1,450원
출력 비용(원) = (출력 토큰 ÷ 1,000,000) x $5.00 x 1,450원
총 비용(원)   = 입력 비용 + 출력 비용
```

> 🧾 사용자가 **매 질문마다** 실시간으로 비용을 확인할 수 있어요!

---

# 🧾 실전 비용 예제: "삼성전자 현재가 알려줘"

### 3번의 조사 과정 (3턴)

| 턴 | 비서의 행동 | 입력 토큰 | 출력 토큰 |
|:---|:---|---:|---:|
| 🔍 1턴 | 종목 검색 | 800 | 200 |
| 📊 2턴 | 시세+뉴스 조회 | 1,200 | 150 |
| 💡 3턴 | 최종 답변 작성 | 1,800 | 500 |
| | **합계** | **3,800** | **850** |

### 🧾 영수증 계산!

```
📥 입력 비용: (3,800 ÷ 1,000,000) x $1.00 x 1,450원 =  5.51원
📤 출력 비용: (  850 ÷ 1,000,000) x $5.00 x 1,450원 =  6.16원
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💰 총 비용:                                           = 11.67원
```

> ☕ 카카오톡 대화 한 번 = 약 **12원!** 커피값(5,000원)으로 **400번** 질문 가능!

---

# 💰 일일/월간 비용 시뮬레이션

### 📊 서비스 규모별 예상 비용 (Haiku 4.5 기준)

| 일일 질문 수 | 일일 비용 | 월 비용 | 연 비용 |
|---:|---:|---:|---:|
| ☕ 100건 | ~1,167원 | ~35,010원 | ~420,000원 |
| 🏢 1,000건 | ~11,670원 | ~350,100원 | ~4,200,000원 |
| 🏭 10,000건 | ~116,700원 | ~3,501,000원 | ~42,000,000원 |

### 💡 비용 절감 팁

| 전략 | 비유 | 절감 효과 |
|:---|:---|:---|
| Haiku 모델 사용 | 🚌 시내버스 타기 | Opus 대비 **15배** 절감! |
| 시스템 프롬프트 최적화 | 📋 지침서 간결하게 | 입력 토큰 절감 |
| 도구 결과 요약 | 📊 보고서 요약본만 | 입력 토큰 대폭 절감 |
| 대화 히스토리 관리 | 🗑️ 오래된 대화 정리 | 장기 대화 비용 절감 |

---

# 퀴즈 타임! 🤔

<br>

## Q. 커피 한 잔(5,000원)으로 AI에게 몇 번 질문할 수 있을까요?

<br>

**A)** 약 10번

**B)** 약 50번

**C)** 약 400번 ✅

**D)** 약 5,000번

<br>

> 💡 정답: **C!** 질문 1건 = 약 12원이니까
> 5,000 ÷ 12 ≈ **약 400번!** ☕🤖
>
> AI가 생각보다 저렴하죠? 😊

---

# 💻 실제 코드: 비용 추적 로깅

> **파일:** `app/api/chat/route.ts`

```typescript
appendEvent({
  event: "response_complete",
  inputTokens: totalInputTokens,
  outputTokens: totalOutputTokens,
  costKRW: Math.round(totalCostKRW * 100) / 100,
  toolCallCount: totalToolCalls,
  durationMs: Date.now() - responseStart,
});
```

### 왜 추적하나요? 📊

| 지표 | 비유 | 용도 |
|:---|:---|:---|
| `costKRW` | 🧾 영수증 | 비용 추이 모니터링 |
| `durationMs` | ⏱️ 응답 시간 | 느린 응답 원인 파악 |
| `toolCallCount` | 🔧 도구 사용 횟수 | 불필요한 호출 최적화 |

---

# ✅ 한 줄 정리

<br>

## 🚕 토큰 비용 = 택시 미터기 (쓴 만큼 과금!)

<br>

> 📥 질문 길이 + 📤 답변 길이 = 💰 비용
> 카톡 한 대화 = 약 **12원!** 걱정하지 마세요 😊

<br>

### 비용 공식 외우기:

```
💰 = (입력 토큰 x 단가) + (출력 토큰 x 단가)
```

---

<!-- _class: lead -->

# 섹션 9
## 👔 모델 선택 전략
### 인턴, 대리, 이사 -- 누구를 부를까?

---

# 🎯 비유: 모델 선택 = 직원 등급 선택 👔

<br>

## 회사에서 직원을 부르는 것과 같아요!

```
📋 업무 난이도에 따라 다른 직원을 부르세요!

  👶 인턴 (Haiku)    -- 빠르고 저렴! 단순 업무에 최적
  👔 대리 (Sonnet)   -- 균형잡힌 능력! 중간 난이도
  🎩 이사 (Opus)     -- 최고 실력! 복잡한 분석
```

<br>

| | 👶 인턴 Haiku | 👔 대리 Sonnet | 🎩 이사 Opus |
|:---|:---|:---|:---|
| 속도 | ⚡ 매우 빠름 | 🏃 보통 | 🚶 느림 |
| 능력 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 비용 | 💚 저렴 | 💛 보통 | ❤️ 비쌈 |

---

# 🔗 이것이 AI에서는... 모델 가격표

### 같은 질문, 다른 직원의 인건비

| 모델 | 입력 단가 | 출력 단가 | 1질문 비용 | 배수 |
|:---|---:|---:|---:|:---|
| 👶 **Haiku 4.5** | $1.00/M | $5.00/M | **11.67원** | 1x |
| 👔 **Sonnet 4** | $3.00/M | $15.00/M | **35.02원** | 3x |
| 🎩 **Opus 4** | $15.00/M | $75.00/M | **175.09원** | 15x |

### 월간 비용 비교 (일 1,000건)

| 모델 | 월 비용 | 비유 |
|:---|---:|:---|
| 👶 Haiku | ~350,100원 | 🍚 식비 수준 |
| 👔 Sonnet | ~1,050,600원 | 🏠 월세 수준 |
| 🎩 Opus | ~5,252,700원 | 🚗 자동차 수준 |

---

# 👔 용도별 추천 모델

<br>

| 용도 | 추천 | 이유 |
|:---|:---|:---|
| 💬 실시간 채팅 (우리!) | 👶 **Haiku** | 빠른 응답 + 낮은 비용 |
| 📄 문서 분석/요약 | 👔 **Sonnet** | 정확도와 비용 균형 |
| 💻 코드 생성/리뷰 | 👔/🎩 **Sonnet/Opus** | 복잡한 추론 필요 |
| 📚 연구/논문 분석 | 🎩 **Opus** | 최고 수준 이해력 |

### 우리가 👶 Haiku를 선택한 이유 5가지

1. ⚡ **속도** -- 주식 정보는 빠른 응답이 생명!
2. 💰 **비용** -- 많은 사용자, 자주 질문 = 저렴해야!
3. ✅ **충분한 성능** -- Tool Use + 한국어에 Haiku로 충분
4. 🔧 **도구가 보완** -- AI 한계를 외부 API가 메움
5. 💬 **스트리밍** -- 빠른 토큰 생성 = 좋은 UX

---

# 🎯 비유: Temperature = 요리 불 세기 🔥

<br>

## 요리할 때 불 세기를 조절하듯, AI의 창의성을 조절해요!

```
🔥 Temperature 조절 다이얼

  0.0 ─── 0.5 ─── 1.0 ─── 1.5 ─── 2.0
  🧊        🌡️       🔥        🌋
 약불      중불      강불     초강불

 정확한    균형     창의적    예측불가
 답변             답변      (위험!)
```

<br>

| 🧊 약불 (0.0~0.3) | 🔥 강불 (0.7~1.0) |
|:---|:---|
| 항상 같은 답변 | 매번 다른 답변 |
| 수학, 코드에 적합 | 글쓰기, 브레인스토밍에 적합 |
| **우리 프로젝트에 적합!** ✅ | 주식 정보에는 위험! ⚠️ |

---

# ✅ 한 줄 정리

<br>

## 👔 모델 선택 = 직원 등급 (인턴/대리/이사)

<br>

> 업무 난이도와 예산에 맞는 직원을 고르세요!
> 단순 업무에 이사(Opus)를 부르면 **비용 낭비** 💸

<br>

### 우리의 선택:

> 👶 **Haiku (인턴)** = 빠르고, 저렴하고, 충분히 유능한 비서!
> 도구(Tool)가 부족한 부분을 보완해줍니다 🔧

---

<!-- _class: lead -->

# 섹션 10
## 🛡️ 에러 핸들링
### 안전장치 만들기!

---

# 🎯 비유: 3중 안전장치 🛡️🛡️🛡️

<br>

## 놀이공원 안전벨트처럼 여러 겹으로 보호해요!

```
🎢 3단계 안전장치

Level 1: 🔧 도구 고장     → "비서야, 여기 고장났어!"
         비서가 사용자에게 안내 → "시세 조회가 안 되네요, 잠시 후 다시..."

Level 2: 📞 전화 끊김     → Claude API 에러
         서버가 에러 신호 전송 → "죄송합니다, 오류 발생!"

Level 3: 🌐 인터넷 끊김   → 네트워크 에러
         브라우저에서 표시   → "연결 오류: 네트워크 문제"
```

<br>

> 🛡️ 어떤 문제가 생겨도 사용자에게 **적절한 메시지**를 보여줘야 해요!

---

# 🔗 Level 1 -- 도구 고장 시 🔧

> **파일:** `app/api/chat/route.ts`

```typescript
try {
  result = await executeTool(tool.name, tool.input);
} catch (e) {
  // 🔧 도구 고장! 하지만 패닉 NO!
  result = JSON.stringify({ error: e.message });
}
// 에러 결과도 Claude에게 전달!
toolResults.push({ type: "tool_result", content: result });
```

### 핵심 원칙 ✨

```
❌ 나쁜 방법: 도구 에러 → 전체 종료 → "오류 발생"
✅ 좋은 방법: 도구 에러 → Claude에게 전달 → 우아한 안내
   "삼성전자 시세 조회가 안 됐어요. 잠시 후 다시 시도해주세요 😊"
```

> 💡 에러를 **삼키지 말고** Claude에게 넘기면 비서가 알아서 안내해요!

---

# 🔗 Level 2 & 3 -- API 에러 & 네트워크 에러

### Level 2: Claude API 에러 📞

```typescript
} catch (error) {
  send({ type: "error", message: error.message });
  // 🛡️ 에러 로깅도 잊지 말기!
}
controller.close();  // 📡 반드시 스트림 종료!
```

### Level 3: 네트워크 에러 🌐

```typescript
} catch (error) {
  setMessages(prev => {
    last.content = `연결 오류: ${error.message}`;
  });
}
setIsLoading(false);  // ⏳ 반드시 로딩 해제!
```

> ⚠️ 어떤 에러가 나도 `setIsLoading(false)` -- **UI가 멈추면 안 돼요!**

---

# 🛑 무한 루프 방지 -- 이중 안전장치

<br>

### 비서가 끝없이 조사하면 안 되니까! 🔄🛑

```typescript
const maxTurns = 10;    // 🛑 최대 10번 조사!
export const maxDuration = 120;  // ⏰ 최대 2분!
```

### 왜 필요한가요?

| 안전장치 | 비유 | 보호 대상 |
|:---|:---|:---|
| `maxTurns = 10` | 🔢 "10번까지만 조사해!" | 💰 비용 폭발 방지 |
| `maxDuration = 120` | ⏰ "2분 안에 끝내!" | ⏳ 서버 자원 보호 |

<br>

> 🛡️ **논리적 제한** (maxTurns) + **시간 제한** (maxDuration) = 이중 방어!

---

# 퀴즈 타임! 🤔

<br>

## Q. 도구 실행 중 에러가 발생하면 어떻게 해야 할까요?

<br>

**A)** 에러를 무시하고 넘어간다

**B)** 전체 프로세스를 즉시 종료한다

**C)** 에러를 Claude에게 전달해서 자연어로 안내하게 한다 ✅

**D)** 에러 메시지를 사용자에게 그대로 보여준다

<br>

> 💡 정답: **C!** Claude 비서에게 상황을 알려주면
> 비서가 알아서 사용자 친화적으로 설명해줘요! 🤖💬

---

# ✅ 한 줄 정리

<br>

## 🛡️ 에러 핸들링 = 3중 안전장치

<br>

> 어떤 문제가 생겨도 사용자에게 **적절한 메시지**를 보여주고,
> **UI가 멈추지 않게** 보호해야 해요!

<br>

### 기억할 것 3가지:

1. 🔧 **도구 에러** → Claude에게 넘겨서 우아하게 안내
2. 🛑 **무한 루프** → maxTurns + maxDuration으로 방지
3. ⏳ **로딩 해제** → 반드시 `setIsLoading(false)` 호출!

---

<!-- _class: lead -->

# 🎓 전체 복습 및 마무리
### 오늘 배운 것을 비유로 정리해볼까요?

---

# 🗺️ 전체 흐름 한 눈에 보기!

```
👤 "삼성전자 요즘 어때?"
  │
  ├── 📱 [브라우저] 서버에 질문 전송
  │     │
  │     ├── 📋 [시스템 프롬프트] 비서 업무 지침서 읽기
  │     │
  │     ├── 🧠 [Claude 비서] 4단계 사고 시작
  │     │     ├── 🔍 의도 분석: "삼성전자 정보 원하시는군!"
  │     │     ├── 📋 탐색 계획: "종목검색 + 시세 + 뉴스!"
  │     │     ├── 🔧 도구 사용: searchStock → getStockQuote
  │     │     └── 💡 최종 답변: "삼성전자는 현재 75,000원..."
  │     │
  │     ├── 💬 [스트리밍] 카톡처럼 한 글자씩 전송
  │     │
  │     └── 🧾 [비용] 입력 3,800 + 출력 850 = 11.67원
  │
  └── 📱 [브라우저] 실시간 렌더링 + 후속질문 버튼!
```

---

# 🎯 오늘의 10가지 비유 총정리!

| 기술 개념 | 일상 비유 | 이모지 |
|:---|:---|:---|
| LLM (대규모 언어모델) | 수천 권의 책을 읽은 천재 비서 | 🧠 |
| 토큰 | 택시 미터기 (글자 수 = 요금) | 🚕 |
| Context Window | 비서의 책상 크기 | 📐 |
| API Key | 도서관 회원증 | 🎫 |
| 시스템 프롬프트 | 비서 채용 시 업무 지침서 | 📋 |
| Chain-of-Thought | "풀이 과정을 보여주세요" | ✏️ |
| Tool Use | "계산기 써도 돼!" 허락 | 🔧 |
| 스트리밍 | 카톡 "입력 중..." vs 이메일 | 💬 |
| 모델 선택 | 직원 등급 (인턴/대리/이사) | 👔 |
| Temperature | 요리 불 세기 | 🔥 |

---

# 📊 핵심 파일 4개만 기억하세요!

<br>

```
🗂️ AI 챗봇의 핵심 파일

📄 app/api/chat/route.ts         ← 🧠 두뇌! Claude 비서 호출
   - 시스템 프롬프트 (업무 지침서)
   - 스트리밍 + Agentic Loop
   - 비용 계산

📄 lib/tools.ts                  ← 🔧 도구함! 비서의 도구 정의
   - 4개 도구 정의
   - 도구 실행 라우터

📄 components/chat.tsx            ← 📱 화면! SSE 수신 + 표시
   - fetch + ReadableStream
   - 이벤트별 상태 업데이트

📄 components/message-bubble.tsx  ← ✂️ 가위! 응답 파싱
   - 사고 과정 분리
   - 후속 질문 추출
```

---

# ✅ 최종 체크리스트

<div class="columns">
<div>

### 🔑 설정

- [ ] 🎫 API Key 발급
- [ ] 🗝️ `.env.local`에 보관
- [ ] 🙈 `.gitignore` 확인

### 📋 프롬프트

- [ ] 🏷️ 역할 정의
- [ ] ✏️ CoT 4단계 지시
- [ ] 📝 출력 형식 명시
- [ ] ⚖️ 면책 조항 포함

</div>
<div>

### 💬 스트리밍

- [ ] 📡 SSE 헤더 설정
- [ ] 📻 `controller.close()` 필수
- [ ] 📱 이벤트별 처리 구현

### 🛡️ 안전

- [ ] 🛑 `maxTurns` 설정
- [ ] 🔧 도구 에러 격리
- [ ] ⏳ `setIsLoading(false)` 보장
- [ ] 🔐 API Key 서버 전용

</div>
</div>

---

# 🚨 자주 하는 실수 TOP 5

<br>

| 순위 | 실수 | 비유 | 해결법 |
|:---|:---|:---|:---|
| 1️⃣ | API Key 노출 | 🔐 비밀번호 공개 | 서버에서만 사용! |
| 2️⃣ | 스트림 미종료 | 💧 수도꼭지 안 잠금 | `controller.close()` 필수 |
| 3️⃣ | 로딩 미해제 | ⏳ 문 잠기고 열쇠 없음 | `setIsLoading(false)` 보장 |
| 4️⃣ | 무한 도구 루프 | 🔄 끝없는 출장 | `maxTurns` 제한 |
| 5️⃣ | 프롬프트-파싱 불일치 | ✂️ 자르는 선이 안 맞음 | 한 쌍으로 관리! |

<br>

> 💡 이 5가지만 조심하면 안전한 AI 서비스를 만들 수 있어요! 🛡️

---

# 🚀 더 발전시키려면?

<br>

### 다음 단계 아이디어 💡

| 아이디어 | 비유 | 설명 |
|:---|:---|:---|
| 🔀 멀티모델 | 업무별 담당자 배정 | 쉬운 질문→Haiku, 어려운 분석→Sonnet |
| 💾 프롬프트 캐싱 | 지침서 복사해 두기 | 같은 지침서 반복 비용 90% 절감 |
| 📝 대화 요약 | 회의록 요약 | 긴 대화 비용 절감 |
| ⭐ 평가 시스템 | 고객 만족도 조사 | 답변 품질 자동 평가 |

<br>

> 🎯 오늘 배운 기본기 위에 하나씩 쌓아올리면 됩니다!

---

# 🎊 최종 퀴즈 타임! -- 5문제 도전!

<br>

| # | 질문 | 정답 |
|:---|:---|:---|
| 1 | LLM을 일상 비유로 하면? | 🧠 수천 권 읽은 천재 비서 |
| 2 | 토큰을 일상 비유로 하면? | 🚕 택시 미터기 |
| 3 | API Key를 일상 비유로 하면? | 🎫 도서관 회원증 |
| 4 | 스트리밍을 일상 비유로 하면? | 💬 카톡 "입력 중..." |
| 5 | 질문 1건 비용은 약 얼마? | ☕ 약 12원! |

<br>

> 🎉 5개 다 맞추셨다면 오늘 강의 **완벽 이해!** 축하해요! 🥳

---

<!-- _class: lead -->
<!-- _paginate: false -->
<!-- _footer: "" -->

# 🎉 수고하셨습니다!

### 오늘부터 여러분은 AI를 이해하는 사람입니다!

<br>

**오늘의 핵심 한 줄:**

> 🧠 **천재 비서**를 고용하고 (LLM)
> 📋 **업무 지침서**를 주고 (시스템 프롬프트)
> 📞 **전화로 질문**하고 (API 호출)
> 🧾 **영수증을 확인**하는 것 (토큰 비용)
>
> **그것이 AI 통합 개발의 전부입니다!**

<br>

**기술 스택:** Next.js 16 + React 19 + TypeScript + Claude Haiku 4.5
**비용:** 질문당 ~12원 ☕ | **핵심 파일:** 4개면 충분!
